

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>工具集 &mdash; AI Express用户手册 2.7.0 文档</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="常见问题" href="faq.html" />
    <link rel="prev" title="场景参考解决方案" href="solution.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> AI Express用户手册
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">快速上手</a></li>
<li class="toctree-l1"><a class="reference internal" href="xstream.html">XStream算法SDK编程框架开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="xproto.html">XProto原型应用开发框架开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="solution.html">场景参考解决方案</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">工具集</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">数据流可视化工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="#profiler">性能Profiler工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="#python-api">Python API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">环境搭建</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#python">搭建Python环境</a></li>
<li class="toctree-l4"><a class="reference internal" href="#xstream-xprotopython">添加动态库和xstream/xproto包到Python搜索路径</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">运行测试脚本</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#xstream-python-api">XStream Python API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">接口描述</a></li>
<li class="toctree-l4"><a class="reference internal" href="#workflow">构建Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">运行Workflow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#xproto-python-api">XProto Python API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">接口描述</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">使用示例</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="version.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="copyright.html">版权声明</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AI Express用户手册</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>工具集</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/BuildAll/doc/tools.md.txt" rel="nofollow"> 查看页面源码</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>工具集<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p>本文介绍AI Express相关工具集，注意：该文档仅仅介绍工具使用方式，不展开将使用教学，可以新搞一个文档链过去，比如：性能profile最佳实践</p>
<div class="section" id="id2">
<h2>数据流可视化工具<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>XStream内的数据流是通过配置json文件来生成的，框架内目前已对数据流配置是否有效进行了检查，而此工具可将配置的json文件数据流向图可视化，生成一份自定义格式的文档或图片，以直观的方式展现json文件中的数据流向。</p>
<p>工具位于<code class="docutils literal notranslate"><span class="pre">source/common/xstream/framework/tools/xstream_framework_datashow.py</span></code></p>
<p><strong>1. 准备环境</strong>：工具通过python3 + graphviz + dot实现，使用前需安装 python3（推荐python3.5.2）、graphviz库、json库</p>
<p><strong>2. 使用工具</strong>：</p>
<p>使用该文件的运行格式为：python xstream_framework_datashow.py xxx.json 效果图如下：</p>
<p><img alt="框架" src="../../_images/xstream_framework_datashow.png" /></p>
<p><strong>3. 可视化后的workflow</strong>：</p>
<ul class="simple">
<li><p>某个node的inputs得不到feed，图中体现为：绿色填充，标签中带有字段：(No-Feed)</p></li>
<li><p>全局inputs和全局outputs重名，图中体现为：红色双箭头边相连，边带有字段：same-global-inputs-outputs</p></li>
<li><p>某些node间的outputs重名，图中体现为：浅蓝色双箭头边相连，边带有字段：same-node-outputs</p></li>
</ul>
</div>
<div class="section" id="profiler">
<h2>性能Profiler工具<a class="headerlink" href="#profiler" title="永久链接至标题">¶</a></h2>
<p>XStream内部提供了性能统计的工具，用户可以通过XStream的对外接口SetConfig打开或关闭该功能，默认该功能关闭。</p>
<ul class="simple">
<li><p>配置profiler功能</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">SetConfig(const</span> <span class="pre">std::string</span> <span class="pre">&amp;key,</span> <span class="pre">const</span> <span class="pre">std::string</span> <span class="pre">&amp;value)</span></code></p>
<p>key为”profiler”, value为”on”, 表示打开性能统计功能。”off”表示关闭, 默认为关闭。</p>
<p>key为”profiler_file”, value为性能统计输出文件路径，用于设置性能统计文件的路径名称，框架层次的统计数据输出至该文件。</p>
<p>若程序中创建多个XStream SDK，则不同的SDK可以设置不同的配置。</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">xstream1</span><span class="o">-&gt;</span><span class="n">SetConfig</span><span class="p">(</span><span class="s">&quot;profiler&quot;</span><span class="p">,</span> <span class="s">&quot;on&quot;</span><span class="p">);</span>  <span class="c1">// 设置打开profiler功能</span>
<span class="n">xstream1</span><span class="o">-&gt;</span><span class="n">SetConfig</span><span class="p">(</span><span class="s">&quot;profiler_file&quot;</span><span class="p">,</span> <span class="s">&quot;./profiler_1.txt&quot;</span><span class="p">);</span>  <span class="c1">// 设置框架层统计数据输出文件</span>

<span class="n">xstream2</span><span class="o">-&gt;</span><span class="n">SetConfig</span><span class="p">(</span><span class="s">&quot;profiler&quot;</span><span class="p">,</span> <span class="s">&quot;on&quot;</span><span class="p">);</span>  <span class="c1">// 设置打开profiler功能</span>
<span class="n">xstream2</span><span class="o">-&gt;</span><span class="n">SetConfig</span><span class="p">(</span><span class="s">&quot;profiler_file&quot;</span><span class="p">,</span> <span class="s">&quot;./profiler_2.txt&quot;</span><span class="p">);</span>  <span class="c1">// 设置框架层统计数据输出文件</span>
</pre></div>
</div>
<p>Method内的统计数据默认输出至文件”PROFILER_METHOD.txt”, 用户若需要更改，可通过访问性能统计的全局单例设置智能策略内的统计数据：<code class="docutils literal notranslate"><span class="pre">Profiler::Get()-&gt;SetOutputFile(&quot;xx.txt&quot;)</span></code></p>
<ul class="simple">
<li><p>性能统计数据类型</p></li>
</ul>
<p>目前XStream内支持的性能统计数据包括处理时长（Time）和帧率（FPS）两种。其中函数处理时长的默认统计最小间隔是3000微秒（即3毫秒），若函数处理时间低于3毫秒，则不计入统计范围；帧率的默认统计最小间隔是200毫秒，若统计周期小于200毫秒，则不计入统计。</p>
<p>为了支持不同业务场景的处理耗时不同，目前支持用户对统计粒度的修改。</p>
<p><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">SetConfig(const</span> <span class="pre">std::string</span> <span class="pre">&amp;key,</span> <span class="pre">const</span> <span class="pre">std::string</span> <span class="pre">&amp;value)</span></code></p>
<p>key为”profiler_time_interval”, value为整型数据（单位：微秒）, 表示设置函数处理时长的最小间隔。</p>
<p>key为”profiler_fps_interval”, value为整型数据（单位：微秒）, 用于设置帧率的最小间隔。</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">xstream1</span><span class="o">-&gt;</span><span class="n">SetConfig</span><span class="p">(</span><span class="s">&quot;profiler_time_interval&quot;</span><span class="p">,</span> <span class="s">&quot;1000&quot;</span><span class="p">);</span>  <span class="c1">// 设置函数处理时长的最小间隔为1毫秒</span>
</pre></div>
</div>
<ul class="simple">
<li><p>性能统计数据可视化</p></li>
</ul>
<p>用户打开性能统计后，若统计结果输出到文件”profiler.txt”，可以通过访问<code class="docutils literal notranslate"><span class="pre">chrome://tracing/</span></code>，通过页面的<code class="docutils literal notranslate"><span class="pre">Load</span></code>按钮将文件加载，即可看到统计数据可视化界面。以下图为例，页面上的横坐标表示”时间”；前几行(标志是字母)的纵坐标表示对应Method处理的帧率；后几行(标志是数字)的纵坐标表示不同线程”thread_id”，同时页面左下角提供了缩放、拖动等工具以便用户查看数据细节。</p>
<p><img alt="统计数据可视化" src="../../_images/profiler.png" /></p>
<p>使用缩放工具缩放坐标，可以查看数据细节，不同的函数执行时间以不同颜色标志，并标记函数处理类型，如下图：
<img alt="统计数据可视化" src="../../_images/profiler_zoom.png" /></p>
</div>
<div class="section" id="python-api">
<h2>Python API<a class="headerlink" href="#python-api" title="永久链接至标题">¶</a></h2>
<p>在XStream/XProto的C++版本外，发布包中提供了简单的XStream/XProto Python API。您可以使用Python API更方便地构建和运行workflow。</p>
<div class="section" id="id3">
<h3>环境搭建<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<div class="section" id="python">
<h4>搭建Python环境<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h4>
<p>目前，地平线提供的开发板上还不包含Python环境。AI-Express为用户提供了可以运行在地平线开发板上的<a class="reference external" href="https://pan.horizon.ai/index.php/s/SYMceymRmm8AbcS">简单Python3.6环境</a>。<br />您可以将压缩包解压至开发板/userdata路径下，之后在开发板/bin路径下创建软链接以使用。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">userdata</span><span class="o">/</span><span class="n">python3</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">6</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span>
</pre></div>
</div>
</div>
<div class="section" id="xstream-xprotopython">
<h4>添加动态库和xstream/xproto包到Python搜索路径<a class="headerlink" href="#xstream-xprotopython" title="永久链接至标题">¶</a></h4>
<p>XStream/XProto Python API中，除Python脚本，还包含以动态库形式存在的对C++版本的封装。这些封装库依赖于C++版本编译出的动态库。您需要将封装动态库添加到Python搜索路径，并设置环境变量以识别C++版本库。在release包中，封装库位于common/xstream/python_api/package/lib/和common/xproto/python_api/package/lib/下。在部署包中，封装库和C++版本库位于lib下。</p>
<p><img alt="XStream Python API库" src="../../_images/xstream_python_lib.png" /></p>
<p><img alt="XProto Python API库" src="../../_images/xproto_python_lib.png" /></p>
<p>运行Python脚本前，您需要设置<em>LD_LIBRARY_PATH</em>环境变量：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:path/to/shared/libraries
</pre></div>
</div>
<p>在Python脚本中，您需要添加动态库到Python搜索路径：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;path/to/shared/libraries&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>xstream/xproto包位于common/xstream/python_api/package/xstream和common/xproto/python_api/package/xproto下。</p>
<p><img alt="XStream Python API包结构" src="../../_images/xstream_python_package.png" /></p>
<p><img alt="XProto Python API包结构" src="../../_images/xproto_python_package.png" /></p>
<p>运行Python脚本前，您需要将它们添加到Python搜索路径下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;path/to/xstream/xproto/packages&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>运行测试脚本<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h4>
<p>XStream/XProto Python API的测试脚本位于common/xstream/python_api/package/tests和common/xproto/python_api/package/tests下</p>
<p><img alt="XStream Python API测试脚本" src="../../_images/xstream_python_test.png" /></p>
<p><em>test_xstream1.py</em>展示了如何创建一个简单的Workflow。<br /><em>test_xstream2.py</em>展示了如何创建含子Workflow的Workflow。<br /><em>test_session.py</em>展示了如何创建并运行一个Workflow。</p>
<p><img alt="XProto Python API测试脚本" src="../../_images/xproto_python_test.png" /></p>
<p><em>test_async.py</em>展示了如何在异步模式下使用XProto Plugin获取图像数据并进行推理。</p>
<p>当您在开发板上设置好Python环境，动态库/包搜索路径后。可以将测试脚本复制到部署包根目录下运行，进行功能验证。相关输出将在命令行中显示。</p>
</div>
</div>
<div class="section" id="xstream-python-api">
<h3>XStream Python API<a class="headerlink" href="#xstream-python-api" title="永久链接至标题">¶</a></h3>
<p>XStream Python API是地平线基于XStream-Framework推出的Python语言的开发库，它让用户可以方便快速地通过Python去使用XStream-Framework来实现智能策略。它是XStream-Framework的一个Python前端，可以通过Python定义XStream-Framework支持的Workflow，并基于Workflow进行同步或异步推理等。</p>
<div class="section" id="id5">
<h4>接口描述<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h4>
<p>目前xstream包中提供了Method，Variable，Session类和一些全局函数。Method，Variable类主要用于构建Workflow。Session类会在运行Workflow时使用。</p>
<div class="section" id="method">
<h5>Method类<a class="headerlink" href="#method" title="永久链接至标题">¶</a></h5>
<p><em>__init__(</em><code class="docutils literal notranslate"><span class="pre">type</span></code><em>)</em></p>
<p>创建一个Method对象</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code> : 要创建的Method类型. Method类型一旦指定后就不可修改.</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>Method对象</p></li>
</ul>
<hr class="docutils" />
<p><em>inputs(</em><code class="docutils literal notranslate"><span class="pre">value</span></code><em>=<code class="docutils literal notranslate"><span class="pre">None</span></code>)</em></p>
<p>设置或返回当前Method的输入数据名字列表.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">value</span></code> : 字符串列表类型或者None.</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为<code class="docutils literal notranslate"><span class="pre">None</span></code>时 : 当前Method的输入参数名字列表.</p></li>
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为字符串列表时 : 当前Method对象.</p></li>
</ul>
<hr class="docutils" />
<p><em>outputs(</em><code class="docutils literal notranslate"><span class="pre">value</span></code><em>=<code class="docutils literal notranslate"><span class="pre">None</span></code>)</em></p>
<p>设置或返回当前Method的输出数据名字列表.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">value</span></code> : 字符串列表类型或者None.</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为<code class="docutils literal notranslate"><span class="pre">None</span></code>时 : 当前Method的输出参数名字列表.</p></li>
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为字符串列表时 : 当前Method对象.</p></li>
</ul>
<hr class="docutils" />
<p><em>method_type()</em></p>
<p>返回当前Method的类型.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>无.</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>字符串 : 当前Method类型.</p></li>
</ul>
<hr class="docutils" />
<p><em>config_file(</em><code class="docutils literal notranslate"><span class="pre">value</span></code><em>=<code class="docutils literal notranslate"><span class="pre">None</span></code>)</em></p>
<p>设置或返回当前Method的配置文件路径.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">value</span></code> : 字符串类型或者None.</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为<code class="docutils literal notranslate"><span class="pre">None</span></code>时 : 当前Method的配置文件路径.</p></li>
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为字符串类型时 : 当前Method对象.</p></li>
</ul>
<hr class="docutils" />
<p><em>config(</em><code class="docutils literal notranslate"><span class="pre">value</span></code><em>=<code class="docutils literal notranslate"><span class="pre">None</span></code>)</em></p>
<p>设置或返回当前Method的配置参数.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">value</span></code> : 字典类型或者None.</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为<code class="docutils literal notranslate"><span class="pre">None</span></code>时 : 当前Method的配置.</p></li>
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为字典类型时 : 当前Method对象.</p></li>
</ul>
<hr class="docutils" />
<p><em>thread_count(</em><code class="docutils literal notranslate"><span class="pre">value</span></code><em>=<code class="docutils literal notranslate"><span class="pre">None</span></code>)</em></p>
<p>设置或返回当前Method的最大线程个数.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">value</span></code> : 整数类型或者None.</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为<code class="docutils literal notranslate"><span class="pre">None</span></code>时 : 当前Method的最大线程数.</p></li>
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为整数类型时 : 当前Method对象.</p></li>
</ul>
<hr class="docutils" />
<p><em>thread_list(</em><code class="docutils literal notranslate"><span class="pre">value</span></code><em>=<code class="docutils literal notranslate"><span class="pre">None</span></code>)</em></p>
<p>设置或返回当前Method的线程ID列表.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">value</span></code> : 整数列表类型或者None.</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为<code class="docutils literal notranslate"><span class="pre">None</span></code>时 : 当前Method的线程ID列表.</p></li>
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为整数列表类型时 : 当前Method对象.</p></li>
</ul>
<hr class="docutils" />
<p><em>__call__(</em><code class="docutils literal notranslate"><span class="pre">*inputs</span></code><em>,</em><code class="docutils literal notranslate"><span class="pre">**attrs</span></code><em>)</em></p>
<p>调用当前method对象, 每次调用代表着在workflow中创建一个节点. 同时在调用时支持覆盖声明Method对象时指定的预定义参数.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">inputs</span></code> : 当前的Method的输入.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">attrs</span></code> : keywords arguments, 用来覆盖Method预定义参数. 支持下列参数:</p>
<ul>
<li><p>Inputs : 输入参数名字列表</p></li>
<li><p>Outputs : 输出参数名字列表</p></li>
<li><p>UniqueName : 当前Node的唯一名字</p></li>
<li><p>ConfigFile : 配置文件路径</p></li>
<li><p>Config : 配置参数</p></li>
<li><p>ThreadCount : 线程最大个数</p></li>
<li><p>ThreadList : 线程ID列表</p></li>
</ul>
</li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为<code class="docutils literal notranslate"><span class="pre">None</span></code>时 : 当前Method的线程ID列表.</p></li>
<li><p>当<code class="docutils literal notranslate"><span class="pre">value</span></code>为整数列表类型时 : 当前Method对象.</p></li>
</ul>
<blockquote>
<div><p><em>Demo</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xstream</span>

<span class="c1"># 预定义该method使用test_cnn.json这个配置文件</span>
<span class="n">method_a</span> <span class="o">=</span> <span class="n">xstream</span><span class="o">.</span><span class="n">Method</span><span class="p">(</span><span class="s2">&quot;CNN&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">config_file</span><span class="p">(</span><span class="s2">&quot;test_cnn.json&quot;</span><span class="p">)</span>

<span class="c1"># 覆盖预定义的ConfigFile配置</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">method_a</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">config_file</span><span class="o">=</span><span class="s2">&quot;test_cnn_2.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="variable">
<h5>Variable类<a class="headerlink" href="#variable" title="永久链接至标题">¶</a></h5>
<p><em>__init__(</em><code class="docutils literal notranslate"><span class="pre">dataName</span></code><em>)</em></p>
<p>实例化一个Variable类型的对象.Variable对象作为workflow的输入和输出数据类型.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dataName</span></code> : Variable的数据名称.</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>Variable对象</p></li>
</ul>
<hr class="docutils" />
<p><em>name()</em></p>
<p>返回当前Variable的名字.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>无</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>字符串 : 该Variable对象的名字.</p></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="session">
<h5>Session类<a class="headerlink" href="#session" title="永久链接至标题">¶</a></h5>
<p><em>__init__(</em><code class="docutils literal notranslate"><span class="pre">workflow</span></code><em>， <em><code class="docutils literal notranslate"><span class="pre">*inputs</span></code></em>, <em><code class="docutils literal notranslate"><span class="pre">method_factory</span></code></em>=[default_factory])</em>
实例化一个Session对象。</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>workflow：定义Workflow的python函数对象。</p></li>
<li><p>inputs：可选参数。该workflow的输入参数。Variable类型。</p></li>
<li><p>method_factory：可选参数。定义Workflow中使用到的Method的实现。</p></li>
</ul>
<blockquote>
<div><p><em>Note</em>
参数用法参考Serialize函数。</p>
</div></blockquote>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>Session对象。</p></li>
</ul>
<hr class="docutils" />
<p><em>callback(</em><code class="docutils literal notranslate"><span class="pre">cb</span></code><em>, <em><code class="docutils literal notranslate"><span class="pre">node_name</span></code></em>=””)</em>
设置Workflow的回调函数。</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>cb：python函数，参数和Node或者Workflow的输出参数对应。作为workflow回调的参数列表中会追加forward的opaque参数传入。参考forward方法参数。</p></li>
<li><p>node_name：节点的unique name。留空代表设置workflow的最终输出。</p></li>
</ul>
<blockquote>
<div><p><em>Note</em>
workflow的输出回调函数的参数将会在后面追加一个opaque，而node的</p>
</div></blockquote>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>整数：0 成功，非零 失败</p></li>
</ul>
<hr class="docutils" />
<p><em>forward(</em><code class="docutils literal notranslate"><span class="pre">**datas</span></code><em>, <em><code class="docutils literal notranslate"><span class="pre">opaqua</span></code></em>=None)</em>
执行异步predic。</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>datas：输入到workflow的数据。keywords 形式的参数。</p></li>
<li><p>opaque：这次输入绑定的上下文信息。会在workflow的最终输出的回调函数中，作为最后一个参数传入。任意类型，XStream内部不会访问。参考callback方法定义。</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>整数 0成功，非零失败</p></li>
</ul>
<hr class="docutils" />
<p><em>close()</em>
关闭Session，释放相关资源。</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>无</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>无</p></li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="id6">
<h5>全局函数<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h5>
<p><em>serialize(</em><code class="docutils literal notranslate"><span class="pre">workflow</span></code><em>, <em><code class="docutils literal notranslate"><span class="pre">*inputs</span></code></em>)</em></p>
<p>该函数用来将一个python定义的workflow转换成XStream框架所能识别的Json格式的配置字符串.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">workflow</span></code> : 定义workflow的python函数对象.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inputs</span></code> : 该workflow的输入参数. <code class="docutils literal notranslate"><span class="pre">Variable</span></code>类型.</p></li>
</ul>
<blockquote>
<div><p><em>Note</em>
当一个workflow函数的参数名字与该workflow的输入数据名字相同时, <code class="docutils literal notranslate"><span class="pre">inputs</span></code>参数可以省略.</p>
</div></blockquote>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>XStream框架支持的workflow json字符串</p></li>
</ul>
<hr class="docutils" />
<p><em>scope(</em><code class="docutils literal notranslate"><span class="pre">name</span></code><em>)</em></p>
<p>该函数创建一个新的名字空间, 在该名字空间下, 所有workflow中定义/生成的Method, Variable的名字都会加上<code class="docutils literal notranslate"><span class="pre">name</span></code>前缀.
当有多级Scope生效时, 各级Scope的<code class="docutils literal notranslate"><span class="pre">name</span></code>会级联.</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> : 当前scope的名字.</p></li>
</ul>
<p><strong>返回值</strong></p>
<ul class="simple">
<li><p>Scope对象</p></li>
</ul>
<blockquote>
<div><p><em>Note</em>
该函数要和Python中的<code class="docutils literal notranslate"><span class="pre">with</span></code>关键字一起使用.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="workflow">
<h4>构建Workflow<a class="headerlink" href="#workflow" title="永久链接至标题">¶</a></h4>
<p>XStream中Workflow是通过Json配置文件来描述的。当一个Workflow变得复杂时，Json配置文件会变得冗长，增加维护的困难性。体现在如下几个方面：</p>
<ul class="simple">
<li><p>串联各个节点的输入和输出名字需要手动填写，容易出错或者造成命名冲突。</p></li>
<li><p>各个节点的顺序关系要保证，对于不熟悉的开发者来说，需要花时间去梳理Node的逻辑关系之后才能添加新的Node。</p></li>
<li><p>无法快速的发现并去除冗余路径上面的节点。</p></li>
<li><p>图可能出现环路。</p></li>
</ul>
<p>实践中发现，构建Workflow的过程其实和编程类似。Json在这个地方就是起到了编程语言的作用。与其发明一种新的语言，就不如使用Python语言来实现快速构建Workflow，并解决上面的问题。</p>
<p>Workflow在Xstream Python API中是以函数的形式存在的。函数的参数就是Workflow的输入，返回值是这个Workflow的输出。各个Node之间的组织关系就是Python中对Node的调用。通过这种方式可以快速的描述Node之间的组织关系。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xstream</span> <span class="k">as</span> <span class="nn">xs</span>
 
<span class="n">bbox_filter_method</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">Method</span><span class="p">(</span><span class="s2">&quot;BBoxFilter&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">inputs</span><span class="p">([</span><span class="s2">&quot;in_bbox&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">outputs</span><span class="p">([</span><span class="s2">&quot;bbox_filtered_A&quot;</span><span class="p">])</span>
<span class="n">bbox_filter_method</span><span class="o">.</span><span class="n">config_file</span><span class="p">(</span><span class="s2">&quot;a_filter.json&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">my_workflow</span><span class="p">(</span><span class="n">in_bbox</span><span class="p">):</span>
    <span class="n">bbox_filtered_A</span> <span class="o">=</span> <span class="n">bbox_filter_method</span><span class="p">(</span><span class="n">in_bbox</span><span class="p">)</span>
    <span class="n">bbox_filtered_B</span> <span class="o">=</span> <span class="n">bbox_filter_method</span><span class="p">(</span><span class="n">in_bbox</span><span class="p">)</span><span class="o">.</span><span class="n">outputs</span><span class="p">([</span><span class="s2">&quot;bbox_filtered_B&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">config_file</span><span class="p">(</span><span class="s2">&quot;b_filter.json&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bbox_filtered_A</span><span class="p">,</span> <span class="n">bbox_filtered_B</span>
</pre></div>
</div>
<p>上述代码示例定义了包含两个Node的Workflow。<br />首先，要创建Workflow中的Node。示例中创建了使用BBoxFilteredMethod的Node。它接收检测框作为输入，输出过滤后的检测框。<br />然后，就可以将Node串联起来，已函数的形式表示Workflow。<br />示例中的in_bbox, bbox_filtered_A等只是一个名字占位符，在将workflow加载到XStream-Framework框架中后，会有实际的数据与之对应。<br />上述示例会构建如下Workflow：</p>
<p><img alt="简单Workflow" src="../../_images/simple_workflow.png" /></p>
</div>
<div class="section" id="id7">
<h4>运行Workflow<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h4>
<p>构建Workflow后，可以通过Session类运行它。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xstream</span> <span class="k">as</span> <span class="nn">xs</span>
<span class="kn">import</span> <span class="nn">vision_type</span> <span class="k">as</span> <span class="nn">vt</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># 使用上一节创建的Workflow</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">my_workflow</span><span class="p">)</span>

<span class="c1"># Workflow回调函数</span>
<span class="k">def</span> <span class="nf">flowcb</span><span class="p">(</span><span class="n">bbox1</span><span class="p">,</span> <span class="n">bbox2</span><span class="p">,</span> <span class="n">opaque</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">bbox1</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">bbox2</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    <span class="n">vt</span><span class="o">.</span><span class="n">bbox_dump</span><span class="p">(</span><span class="n">bbox1</span><span class="p">)</span>
    <span class="n">vt</span><span class="o">.</span><span class="n">bbox_dump</span><span class="p">(</span><span class="n">bbox2</span><span class="p">)</span>

<span class="n">session</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">flowcb</span><span class="p">)</span>

<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">session</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">in_bbox</span><span class="o">=</span><span class="n">vt</span><span class="o">.</span><span class="n">bbox</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>上述代码示例中首先创建了一个Session对象。创建该对象时需要传入表示Workflow的函数。XStream包内部会调用serialize方法，将Workflow保存为Json文件，并创建对应的XStream SDK实例。<br />之后，调用Session类的callback接口，指定Workflow的回调函数。随后调用Session类的forward接口，输入数据到XStream-Framework进行推理。<br />上述代码示例将循环100次，输入检测框，打印过滤后的框信息。</p>
</div>
</div>
<div class="section" id="xproto-python-api">
<h3>XProto Python API<a class="headerlink" href="#xproto-python-api" title="永久链接至标题">¶</a></h3>
<p>XProto Python API是地平线基于XProto-Framework推出的Python语言的开发库。它让用户可以方便地通过Python去使用XProto-Framework中的组件，快速搭建智能应用、验证算法效果。目前XProto Python API仅支持对原生Plugin的调度。XProto Python API需要和XStream Python API配合使用，以实现运行算法/策略的目的。</p>
<div class="section" id="id8">
<h4>接口描述<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h4>
<p>目前xproto包中提供了VioPlugin, SmartPlugin类。VioPlugin类完成对VioPlugin的C++实现的调度，处理图像输入数据。SmartPlugin类内部调用XStream Python API接口，运行算法模型和策略。</p>
<div class="section" id="vioplugin">
<h5>VioPlugin类<a class="headerlink" href="#vioplugin" title="永久链接至标题">¶</a></h5>
<p><em><strong>init</strong>(</em><code class="docutils literal notranslate"><span class="pre">platform</span></code><em>, <em><code class="docutils literal notranslate"><span class="pre">sensor</span></code></em>=”default”, <em><code class="docutils literal notranslate"><span class="pre">vio_type</span></code></em>=”single_cam”, <em><code class="docutils literal notranslate"><span class="pre">data_source</span></code></em>=”default”, <em><code class="docutils literal notranslate"><span class="pre">**kwargs</span></code></em>)</em></p>
<p>创建VioPlugin实例</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>platform: 程序运行的平台，目前支持”x3dev”</p></li>
<li><p>sensor: 使用的sensor，目前支持”default”(X2平台自带的sensor)，”imx327”</p></li>
<li><p>vio_type: vio类型，仅在X3平台下使用。目前支持”single_cam”</p></li>
<li><p>data_source: 回灌模式下使用的数据源，目前支持”cache”, “jpg”, “nv12”</p></li>
<li><p>**kwargs: 其他参数，留用</p></li>
</ul>
<p><strong>返回值</strong></p>
<p>VioPlugin实例</p>
<hr class="docutils" />
<p><em>start(</em><code class="docutils literal notranslate"><span class="pre">sync_mode</span></code><em>=”False”)</em></p>
<p>启动VioPlugin</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>sync_mode: 是否设置VioPlugin为同步模式</p></li>
</ul>
<p><strong>返回值</strong></p>
<p>0：成功，&lt;0：错误码</p>
<hr class="docutils" />
<p><em>stop()</em>
停止VioPlugin</p>
<p><strong>参数</strong></p>
<p>无</p>
<p><strong>返回值</strong></p>
<p>0：成功，&lt;0：错误码</p>
<hr class="docutils" />
<p><em>message_type()</em></p>
<p>返回VioPlugin产生的消息的类型</p>
<p><strong>参数</strong></p>
<p>无</p>
<p><strong>返回值</strong></p>
<p>消息类型列表</p>
<hr class="docutils" />
<p><em>bind(</em><code class="docutils literal notranslate"><span class="pre">msg_type</span></code><em>, <em><code class="docutils literal notranslate"><span class="pre">msg_cb</span></code></em>=None)</em></p>
<p>绑定VioPlugin需要使用的消息并指定回调函数</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>msg_type：消息类型</p></li>
<li><p>msg_cb: 消息对应的回调函数</p></li>
</ul>
<p><strong>返回值</strong></p>
<p>无</p>
<hr class="docutils" />
<p><em>get_image()</em></p>
<p>同步模式下获取输入数据</p>
<p><strong>参数</strong></p>
<p>无</p>
<p><strong>返回值</strong></p>
<p>输入数据列表</p>
<hr class="docutils" />
<p><em>get_name_list()</em></p>
<p>返回回灌图像列表</p>
<p><strong>参数</strong></p>
<p>无</p>
<p><strong>返回值</strong></p>
<p>回灌图像列表</p>
</div>
<hr class="docutils" />
<div class="section" id="smartplugin">
<h5>SmartPlugin类<a class="headerlink" href="#smartplugin" title="永久链接至标题">¶</a></h5>
<p><em><strong>init</strong>(</em><code class="docutils literal notranslate"><span class="pre">workflow</span></code><em>, <em><code class="docutils literal notranslate"><span class="pre">callback</span></code></em>, <em><code class="docutils literal notranslate"><span class="pre">serialize</span></code></em>, <em><code class="docutils literal notranslate"><span class="pre">push_result</span></code></em>=False)</em></p>
<p>创建SmartPlugin实例</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>workflow: 表示workflow的函数</p></li>
<li><p>callback：workflow回调函数</p></li>
<li><p>serialize: 智能数据序列化函数，目前暂不支持使用</p></li>
<li><p>push_result: 是否向XProto-Framework总线推数据，目前暂不支持推数据</p></li>
</ul>
<p><strong>返回值</strong></p>
<p>SmartPlugin实例</p>
<hr class="docutils" />
<p><em>start()</em></p>
<p>启动SmartPlugin实例</p>
<p><strong>参数</strong></p>
<p>无</p>
<p><strong>返回值</strong></p>
<p>无</p>
<hr class="docutils" />
<p><em>stop()</em></p>
<p>停止SmartPlugin实例</p>
<p><strong>参数</strong></p>
<p>无</p>
<p><strong>返回值</strong></p>
<p>无</p>
<hr class="docutils" />
<p><em>bind(</em><code class="docutils literal notranslate"><span class="pre">msg_type</span></code><em>, <em><code class="docutils literal notranslate"><span class="pre">msg_cb</span></code></em>)</em></p>
<p>绑定SmartPlugin需要使用的消息和回调函数</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>msg_type: 消息类型</p></li>
<li><p>msg_cb: 消息对应的回调函数</p></li>
</ul>
<p><strong>返回值</strong></p>
<p>无</p>
<hr class="docutils" />
<p><em>feed(</em><code class="docutils literal notranslate"><span class="pre">inputs</span></code><em>)</em></p>
<p>同步模式下接收输入并做推理</p>
<p><strong>参数</strong></p>
<ul class="simple">
<li><p>inputs: 输入数据，字典格式。key：输入数据名，value：输入数据</p></li>
</ul>
<p><strong>返回值</strong></p>
<p>无</p>
<hr class="docutils" />
<p><em>message_type()</em></p>
<p>返回SmartPlugin产生的消息的类型</p>
<p><strong>参数</strong></p>
<p>无</p>
<p><strong>返回值</strong></p>
<p>消息类型列表</p>
</div>
</div>
<div class="section" id="id9">
<h4>使用示例<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h4>
<p>您可以使用VioPlugin获取图像输入，之后使用SmartPlugin来运行算法模型或策略。为了实现运行算法模型和策略，XProto Python API需要和XStream Python API配合使用。<br />VioPlugin获取图像数据分为同步模式和异步模式。同步模式下VioPlugin不向总线推数据。您可以通过调用SmartPlugin的Feed接口，使用经VioPlugin处理的图像数据。异步模式下，VioPlugin会向总线推数据。您需要使用SmartPlugin监听消息。</p>
<p><strong>同步模式</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xproto</span> <span class="k">as</span> <span class="nn">xp</span>
 
<span class="c1"># 创建VioPlugin，SmartPlugin</span>
<span class="n">vio</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">VioPlugin</span><span class="p">(</span><span class="s2">&quot;x3dev&quot;</span><span class="p">,</span> <span class="s2">&quot;hg&quot;</span><span class="p">,</span> <span class="s2">&quot;single_feedback&quot;</span><span class="p">,</span> <span class="s2">&quot;jpg&quot;</span><span class="p">)</span>
<span class="n">smart</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">SmartPlugin</span><span class="p">(</span><span class="n">my_workflow</span><span class="p">,</span> <span class="n">smart_data_cb</span><span class="p">)</span>

<span class="c1"># 以同步模式启动VioPlugin</span>
<span class="n">vio</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vio</span><span class="o">.</span><span class="n">get_name_list</span><span class="p">())</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">in_file</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">)</span>
<span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">processed</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="c1"># 获取图像并进行推理</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">vio</span><span class="o">.</span><span class="n">get_image</span><span class="p">()</span>
    <span class="n">smart</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">processed</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">vio</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="n">smart</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>上述示例展示了使用VioPlugin同步模式进行回灌。<br />首先创建了VioPlugin和SmartPlugin实例。之后启动VioPlugin，同步模式下需要指定sync_mode为True。然后，通过VioPlugin的get_image接口获取VioPlugin处理的图像数据，并通过SmartPlugin的feed接口将图像数据输入到XStream Workflow进行推理。</p>
<p><strong>异步模式</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xproto</span> <span class="k">as</span> <span class="nn">xp</span>

<span class="c1"># 创建插件</span>
<span class="n">vio</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">VioPlugin</span><span class="p">(</span><span class="s2">&quot;x3dev&quot;</span><span class="p">,</span> <span class="s2">&quot;imx327&quot;</span><span class="p">)</span>
<span class="n">smart</span> <span class="o">=</span> <span class="n">xp</span><span class="o">.</span><span class="n">SmartPlugin</span><span class="p">(</span><span class="n">my_workflow</span><span class="p">,</span> <span class="n">smart_data_cb</span><span class="p">)</span>
<span class="c1"># SmartPlugin监听VioPlugin产生的消息</span>
<span class="n">smart</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">vio</span><span class="o">.</span><span class="n">get_message_type</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># 启动Plugins</span>
<span class="n">vio</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">smart</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">vio</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
<span class="n">smart</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>上述示例展示了以VioPlugin异步模式使用sensor图像。<br />相似地，需要先创建VioPlugin和SmartPlugin实例。对于SmartPlugin，需要绑定VioPlugin产生的消息以监听并使用它。之后，只需要启动和停止plugin即可。</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; 版权所有 2020, Horizon Robotics

    </p>
  </div>
    
    
    
    利用 <a href="http://sphinx-doc.org/">Sphinx</a> 构建，使用了 
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">主题</a>
    
    由 <a href="https://readthedocs.org">Read the Docs</a>开发. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>